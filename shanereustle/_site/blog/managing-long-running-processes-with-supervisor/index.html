<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8'>
		<meta http-equiv='X-UA-Compatible' content='IE=edge'>
		<meta name='viewport' content='width=device-width, initial-scale=1'>
		
		<title>Managing Long-Running Processes With Supervisor | Shane Reustle</title>
		<link rel='canonical' href='http://shanereustle.com/blog/managing-long-running-processes-with-supervisor'>
		
		<link href='/static/lib/bootstrap/css/bootstrap.min.css' rel='stylesheet'>
		<link href='/css/main.css' rel='stylesheet'>
		
	</head>
	<body>
		
		<nav class='navbar navbar-inverse navbar-fixed-top'>
			<div class='container'>
				<div class='row'>
					<div class='col-md-8 col-md-offset-2'>
						<div class='navbar-header'>
							<button type='button' class='navbar-toggle collapsed' data-toggle='collapse' data-target='.navbar-collapse' aria-expanded='false' aria-controls='navbar'>
								<span class='sr-only'>Toggle navigation</span>
								<span class='icon-bar'></span>
								<span class='icon-bar'></span>
								<span class='icon-bar'></span>
							</button>
							<a class='navbar-brand' href='/'>Shane Reustle</a>
						</div>
						<div id='navbar' class='collapse navbar-collapse'>
							<ul class='nav navbar-nav'>
								
								<li><a href='/'>Home</a></li>
								<li class='active' ><a href='/blog/'>Articles</a></li>
								<!--<li><a href='/photography/'>Photography</a></li>-->
								<li  ><a href='/newsletter'>Newsletter</a></li>
								
							</ul>
							<ul class='nav navbar-nav navbar-right'>
								
								<li class='drodown'>
									<a href='#' class='dropdown-toggle' data-toggle='dropdown'>Contact <span class='caret'></span></a>
									<ul class='dropdown-menu'>
										<li><a href='mailto:me@shanereustle.com' target='_blank'>Email</a></li>
										<li><a href='http://facebook.com/shanereustle' target='_blank'>Facebook</a></li>
										<li><a href='http://twitter.com/reustle' target='_blank'>Twitter</a></li>
									</ul>
								</li>
								
							</ul>
						</div><!--/.nav-collapse -->
					</div>
				</div>
			</div>
		</nav>
		
		<div class='container'>
			
			<div class='row'>
				<div class='col-md-8 col-md-offset-2'>
					
					<h1>Managing Long-Running Processes With Supervisor</h1>

<p><a href="http://supervisord.org/">Supervisor</a> is a great tool to start and manage long-running processes and the log files associated with them. It offers a lot of helpful features and is easy to get up and running.</p>

<h2 id="install-amp-start-supervisor">Install &amp; Start Supervisor</h2>

<p>Supervisor works out of the box, so this part is easy.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">sudo apt-get install supervisor -y <span class="o">&amp;&amp;</span> sudo supervisord</code></pre></div>

<h2 id="our-first-program">Our First Program</h2>

<p>Supervisor looks for configuration files in <strong>/etc/supervisor/conf.d/</strong> and it is a good idea to keep a single conf file per process. To start, let’s set up a simple long-running python script. Don’t pay too much attention to the contents of the conf file, we’ll go over that later.</p>

<p><em>Create /etc/supervisor/conf.d/test_python.conf containing:</em></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>program:test_python<span class="o">]</span>
<span class="nb">command</span><span class="o">=</span>python -u test.py
<span class="nv">directory</span><span class="o">=</span>/home/ubuntu
<span class="nv">stdout_logfile</span><span class="o">=</span>/home/ubuntu/test_python_output.txt
<span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span></code></pre></div>

<p><em>Create ~/test.py containing:</em></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">())</span>
	<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></code></pre></div>

<p>When creating the conf file, be sure to replace <strong>/home/ubuntu</strong> both times with the path to your home directory (~ isn’t allowed). If you run test.py manually you’ll see it prints out the time once per second.</p>

<h2 id="using-supervisorctl">Using SupervisorCTL</h2>

<p>SupervisorCTL is the tool you will use to manage everything in Supervisor. Start by running <strong>sudo supervisorctl</strong> and then typing <strong>reread</strong>. The reread command goes through the conf.d directory and loads any new program conf files. Once you see the new test_python program available, you can use the add command to load and start it (<strong>add test_python</strong>). The <strong>status</strong> command shows you all running processes, their PID and how long they’ve been running. Here is a short list of my commonly used supervisorctl commands and what they do.</p>

<dl class="dl-horizontal">
	<dt>reread</dt>
	<dd>Reload all program conf files from the conf.d directory.</dd>
	
	<dt>add [program_name]</dt>
	<dd>Add a newly created conf file to Supervisor and start the process.</dd>
	
	<dt>status</dt>
	<dd>Check the status of all programs currently managed by Supervisor.</dd>
	
	<dt>start [program_name]</dt>
	<dd>Start the given program. Used often with one-time scripts.</dd>
	
	<dt>restart [program_name]</dt>
	<dd>Restart the given program.</dd>
	
	<dt>tail -f [program_name]</dt>
	<dd>Watch the log file in real-time (same as UNIX tail -f [filename]).</dd>
	
	<dt>help</dt>
	<dd>List all available commands.</dd>
</dl>

<p>Exit supervisorctl and check your log file (~/test_python_output.txt) to see that it is still running. If it isn’t, you may have missed a step.</p>

<h2 id="program-configuration-files">Program Configuration Files</h2>

<p>There is a wide array of options you can use while setting up your program configuration file. I’ve listed my favorite options below. For a full list of commands and their parameters, check out <a href="http://supervisord.org/configuration.html#program-x-section-settings">the settings documentation</a></p>

<dl class="dl-horizontal">
	<dt>command</dt>
	<dd>The command to run.</dd>
	
	<dt>directory</dt>
	<dd>The directory to run the command in.</dd>
	
	<dt>numprocs</dt>
	<dd>Automatically start N instances of that process.</dd>
	
	<dt>autostart</dt>
	<dd>A boolean which tells whether to run automatically or not when Supervisor starts.</dd>
	
	<dt>autorestart</dt>
	<dd>Automatically restart a process that dies, under specific conditions (see docs).</dd>
	
	<dt>stdout_logfile</dt>
	<dd>Where to log the output of your program.</dd>
	
	<dt>redirect_stderr</dt>
	<dd>Tell supervisor whether to include stderr in your standard output file.</dd>
	
	<dt>stdout_logfile_maxbytes</dt>
	<dd>The size a log file is allowed to grow to until it is auto rotated.</dd>
	
	<dt>stdout_logfile_backups</dt>
	<dd>The number of rotated log files to keep.</dd>
</dl>

<h2 id="web-interface">Web Interface</h2>

<p>Supervisor provides a really nifty web interface to monitor and restart your processes. Just update the following file, restart supervisor, and you’ll see it on port 9001. Feel free to change the port and protect it using HTTP Auth or whatever you see fit.</p>

<p><em>Add the following to /etc/supervisor/supervisord.conf</em></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>inet_http_server<span class="o">]</span> 
<span class="nv">port</span><span class="o">=</span>*:9001</code></pre></div>

<h2 id="one-time-scripts">One-Time Scripts</h2>

<p>I’ve found that Supervisor also works great for running commonly used scripts that have multiple parameters or large log files. Be sure to set <strong>autostart</strong> and <strong>autorestart</strong> in the conf file to false, so your script doesn’t end up running repeatedly.</p>

<h2 id="examples">Examples</h2>

<p><em>MongoDB</em></p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>program:mongod_member<span class="o">]</span>
<span class="nb">command</span><span class="o">=</span>/home/ubuntu/mongodb-linux-x86_64-2.0.6/bin/mongod --dbpath /mnt/mongo/ --replSet mongo5 --nojournal
<span class="nv">directory</span><span class="o">=</span>/home/ubuntu
<span class="nv">stdout_logfile</span><span class="o">=</span>/mnt/log/mongod.log
<span class="nv">redirect_stderr</span><span class="o">=</span><span class="nb">true</span></code></pre></div>



<div class='row'>
	
	<div class='col-md-4'>
		<a href='/blog/' class='btn btn-default footer-action'><span class='glyphicon glyphicon-chevron-left'></span> Back to Article List</a>
	</div>
	
	<div class='col-md-4 article-date text-center'>
		Jul 28, 2012
	</div>
	
	<div class='col-md-4 text-right'>
		<a href='http://twitter.com/reustle' class='btn btn-default footer-action'>Follow on Twitter</a>
	</div>

</div>


					
				</div>
			</div>
			
		</div>
		
		<script src='/static/lib/jquery-1.11.1.min.js'></script>
		<script src='/static/lib/bootstrap/js/bootstrap.min.js'></script>
		<script>
			
			// Google Analytics
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
			ga('create', 'UA-2580539-25', 'shanereustle.com');
			ga('send', 'pageview');
			
		</script>
		
	</body>

</html>

