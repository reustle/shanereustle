<!doctype html>
<html lang='en'>
	<head>
		<meta charset='utf-8'/>
		<title>Free Up The Event Loop With Web Workers | Shane Reustle</title>
		<link rel='stylesheet' href='../static/css/blog.css'/>
		<link rel='canonical' href='http://shanereustle.com/blog/free-up-the-event-loop-with-web-workers.html'/>
	</head>
	<body>
		<div id='wrapper'>

<h1>Free Up The Event Loop With Web Workers</h1>
<h2 class='date'>31 January 2012</h2>
<p>JavaScript gives us an event loop so we can set timeouts and listeners without blocking the entire program. The problem with this approach shows when you start writing CPU intensive code. The event loop can only execute one task at a time, so if one of those tasks takes 5 seconds, nothing else can run until that is finished. On top of the JavaScript engine being locked during this time, the browser will not render any UI changes. This results in the entire browser freezing. As we move to heavier client side applications, this limitation becomes more obvious.</p>
<p>Web Workers are one of the new features in the HTML5 spec and allow us to essentially create multiple event loops. By running expensive operations in their own threads, the user experience stays responsive. Below is an example of an expensive operation implemented with and without a worker.</p>

<input type='button' value='Find 4,000th Prime' onclick='find_prime(4000)'/><br/>
<input type='button' value='Find 4,000th Prime with Web Worker' onclick='find_prime_worker(4000)'/><br/>
<div id='result'>&nbsp;</div>

<p>A worker is initiated by passing a JavaScript file which includes a specific event listener. No global variables are available in the worker, which includes the document and window objects. The only way to pass data in is to fire a message event to the worker as a string. More recently, browsers have been starting to support sending an object which will be json stringified, but to be safe you can always do that yourself before sending the data.</p>
<p>Take a look at the source of this page for a simple working example. You can <a href='https://developer.mozilla.org/En/Using_web_workers'>read more about web workers here</a>. Feel free to <a href='mailto:sreustle@gmail.com'>ask me</a> any questions you have.</p>

<script>
	
	var start_time;
	
	var find_prime = function(nth_prime){
		// Find Nth prime
		
		document.getElementById('result').innerHTML = 'Running...';
		
		start_time = new Date();
		
		var is_prime = function(num){
			// The purpose of this function is to be slow
			
			var counter = num - 1;
			while(counter > 1){
				if(num % counter == 0){
					return false;
				}
				counter--;
			}
			return true;
		};
		
		var current_num = 3;
		var primes = [];
		
		while(primes.length != nth_prime){
			if(is_prime(current_num)){
				primes.push(current_num);
			}
			current_num++;
		}
			
		var result = primes[primes.length - 1];
		
		var duration = parseFloat((new Date()) - start_time) / 1000;
		
		document.getElementById('result').innerHTML = 'Took ' + duration + ' seconds';
		
	};
	
	// Initiate the worker. It will now wait for messages.
	var worker = new Worker('resources/find_prime.js');
	
	var find_prime_worker = function(nth_prime){
		// Find Nth prime using a web worker
		
		document.getElementById('result').innerHTML = 'Running...';
		
		start_time = new Date();
		
		// Send the worker a message.
		worker.postMessage(nth_prime);
		
	};
	
	worker.onmessage = function(event){
		// Once the worker returns the result, update the UI
		
		var result = event.data;
		
		var duration = parseFloat((new Date()) - start_time) / 1000;
		
		document.getElementById('result').innerHTML = 'Took ' + duration + ' seconds';
		
	};

</script>

		</div>
		<script type='text/javascript' src='../static/js/blog.js'></script>
		<script type='text/javascript' src='../static/js/ga.js'></script>
	</body>
</html>

